<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMRS - Loket Pendaftaran</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'blue-primary': '#4F46E5',
                        'blue-light': '#EEF2FF',
                        'gray-light': '#F8FAFC'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 font-inter">
    <!-- Kontainer Sidebar -->
    <div id="sidebar-container"></div>
    <script>
        fetch('../../src/components/sidebar.html')
            .then(res => res.text())
            .then(html => {
                document.getElementById('sidebar-container').innerHTML = html;
            });
    </script>

    <!-- Konten Utama -->
    <div class="lg:ml-64 min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b sticky top-0 z-40">
            <div class="flex items-center justify-between px-4 lg:px-6 py-4">
                <nav class="flex items-center space-x-2 text-sm text-gray-600">
                    <span>Home</span>
                    <span>></span>
                    <span class="text-gray-900 font-medium">Loket Pendaftaran</span>
                </nav>
                <div class="flex items-center space-x-2">
                    <span class="text-gray-700 hidden sm:block">Admin</span>
                    <button class="p-2 rounded-lg hover:bg-gray-100">
                        <i class="fas fa-user-circle text-gray-500"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Konten Utama -->
        <div class="p-4 lg:p-6">
            <div class="max-w-7xl mx-auto">
                <!-- Section Filter dan Antrian -->
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-6">
                    <!-- Panel Filter Data -->
                    <div class="xl:col-span-2 bg-blue-light p-4 lg:p-6 rounded-lg border border-blue-200">
                        <h2 class="text-lg font-bold text-blue-600 mb-6">FILTER DATA</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 lg:gap-6 mb-6">
                            <!-- Input Tanggal Registrasi -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">TANGGAL REGISTRASI</label>
                                <div class="flex flex-col sm:flex-row items-center gap-3">
                                    <input type="date" 
                                           id="dateFrom"
                                           value="2025-07-16" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                                    <span class="text-sm text-gray-600 font-medium">s.d.</span>
                                    <input type="date" 
                                           id="dateTo"
                                           value="2025-07-16" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                                </div>
                            </div>

                            <!-- Filter Cara Bayar -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">CARA BAYAR</label>
                                <div class="relative">
                                    <select id="filterPayment" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent appearance-none bg-white transition-all">
                                        <option value="">Semua</option>
                                        <option value="BPJS">BPJS</option>
                                        <option value="Umum">Umum</option>
                                        <option value="Asuransi">Asuransi</option>
                                    </select>
                                    <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                                </div>
                            </div>

                            <!-- Filter Poliklinik -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">POLIKLINIK</label>
                                <div class="relative">
                                    <select id="filterClinic" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent appearance-none bg-white transition-all">
                                        <option value="">Semua</option>
                                        <option value="Poli Bedah Ortopedi">Poli Bedah Ortopedi</option>
                                        <option value="Poli Gigi">Poli Gigi</option>
                                        <option value="Poli Umum">Poli Umum</option>
                                        <option value="Poli Jantung">Poli Jantung</option>
                                        <option value="Poli Anak">Poli Anak</option>
                                        <option value="Poli Mata">Poli Mata</option>
                                    </select>
                                    <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                                </div>
                            </div>

                            <!-- Filter Dokter -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">DOKTER</label>
                                <div class="relative">
                                    <select id="filterDoctor" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent appearance-none bg-white transition-all">
                                        <option value="">Semua</option>
                                        <option value="dr. Budi Sp.OT">dr. Budi Sp.OT</option>
                                        <option value="drg. Andi Prasetyo, Sp.KG">drg. Andi Prasetyo, Sp.KG</option>
                                        <option value="dr. Sarah">dr. Sarah</option>
                                        <option value="dr. Sari Sp.JP">dr. Sari Sp.JP</option>
                                        <option value="dr. Ahmad Sp.A">dr. Ahmad Sp.A</option>
                                    </select>
                                    <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Area Pencarian dan Tombol -->
                        <div class="flex flex-col sm:flex-row gap-3">
                            <div class="flex-1">
                                <input type="text" 
                                       id="searchInput"
                                       placeholder="Ketik NRM, Nama Pasien atau NIK" 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent placeholder-gray-500 transition-all">
                            </div>
                            <div class="flex gap-3">
                                <button onclick="applyFilter()" class="px-4 lg:px-6 py-2 bg-green-100 text-green-600 border border-green-300 rounded-md hover:bg-green-200 transition-colors duration-200 flex items-center gap-2 font-medium">
                                    <i class="fas fa-search"></i>
                                    <span>Cari</span>
                                </button>
                                <button onclick="resetFilter()" class="px-4 lg:px-6 py-2 bg-red-100 text-red-600 border border-red-300 rounded-md hover:bg-red-200 transition-colors duration-200 flex items-center gap-2 font-medium">
                                    <i class="fas fa-redo"></i>
                                    <span>Reset</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Panel Antrian Loket -->
                    <div class="bg-blue-light border-blue-200 p-4 lg:p-6 rounded-lg shadow-sm border flex flex-col justify-center items-center min-h-[300px]">
                        <!-- Info Sisa Antrian -->
                        <div class="text-center mb-6">
                            <p class="text-sm text-gray-600 font-medium">
                                Sisa Antrian Loket <span id="currentLoketDisplay" class="font-bold text-blue-600">1</span> : 
                                <span id="remainingQueueDisplay" class="font-bold text-blue-600">13</span>
                            </p>
                        </div>

                        <!-- Display Nomor Antrian -->
                        <div class="text-center mb-8">
                            <div class="text-6xl lg:text-8xl xl:text-9xl font-bold text-blue-600 tracking-wider transition-all duration-300" id="currentQueueDisplay">001</div>
                        </div>

                        <!-- Tombol Kontrol Antrian -->
                        <div class="flex justify-center gap-3 lg:gap-4">
                            <button onclick="resetQueueFunction()" 
                                    class="w-12 h-12 lg:w-16 lg:h-16 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 flex items-center justify-center shadow-md" 
                                    title="Reset Antrian" 
                                    id="resetBtn">
                                <i class="fas fa-redo text-lg lg:text-xl"></i>
                            </button>
                            <button onclick="repeatCallFunction()" 
                                    class="w-12 h-12 lg:w-16 lg:h-16 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200 flex items-center justify-center shadow-md" 
                                    title="Panggil Antrian" 
                                    id="soundBtn">
                                <i class="fas fa-volume-up text-lg lg:text-xl"></i>
                            </button>
                            <button onclick="callNextQueueFunction()" 
                                    class="w-12 h-12 lg:w-16 lg:h-16 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors duration-200 flex items-center justify-center shadow-md" 
                                    title="Antrian Selanjutnya" 
                                    id="nextBtn">
                                <i class="fas fa-forward text-lg lg:text-xl"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Header Tabel -->
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
                    <h3 class="text-lg font-bold text-blue-600 uppercase">DATA PASIEN RAWAT JALAN</h3>
                    <a href="../../pasien/tambah.html" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-medium inline-flex items-center gap-2">
                        <i class="fas fa-plus"></i>
                        <span>Tambah Pasien</span>
                    </a>
                </div>

                <!-- Tabel Data Pasien -->
                <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full min-w-[800px]">
                            <thead class="bg-gray-50">
                                <tr class="text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                    <th class="px-4 py-3 text-center w-16">NO</th>
                                    <th class="px-4 py-3 text-center w-20">AKSI</th>
                                    <th class="px-4 py-3 w-24">TANGGAL</th>
                                    <th class="px-4 py-3 w-20">NRM</th>
                                    <th class="px-4 py-3 w-40">NAMA PASIEN</th>
                                    <th class="px-4 py-3 w-32">NIK</th>
                                    <th class="px-4 py-3 text-center w-16">J.K.</th>
                                    <th class="px-4 py-3 w-40">POLIKLINIK</th>
                                    <th class="px-4 py-3 w-40">DOKTER PJ</th>
                                    <th class="px-4 py-3 w-24">CARA BAYAR</th>
                                    <th class="px-4 py-3 w-32">TINDAK LANJUT</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="patientTable">
                                <!-- Data akan diisi melalui JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Paginasi -->
                    <div class="px-4 py-3 border-t bg-gray-50 flex flex-col sm:flex-row items-center justify-between gap-4">
                        <p class="text-sm text-gray-600">Menampilkan 1-10 dari 100 data</p>
                        <div class="flex space-x-1">
                            <button class="px-3 py-2 text-sm text-gray-500 hover:text-gray-700 border rounded transition-colors">‹</button>
                            <button class="px-3 py-2 text-sm bg-blue-500 text-white rounded">1</button>
                            <button class="px-3 py-2 text-sm text-gray-700 hover:text-gray-900 border rounded transition-colors">2</button>
                            <button class="px-3 py-2 text-sm text-gray-700 hover:text-gray-900 border rounded transition-colors">3</button>
                            <button class="px-3 py-2 text-sm text-gray-500 hover:text-gray-700">...</button>
                            <button class="px-3 py-2 text-sm text-gray-700 hover:text-gray-900 border rounded transition-colors">10</button>
                            <button class="px-3 py-2 text-sm text-gray-500 hover:text-gray-700 border rounded transition-colors">›</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Tambah Kunjungan -->
    <div id="addModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-lg w-full max-w-md transform transition-all duration-300 scale-95 opacity-0" id="addModalContent">
            <div class="bg-blue-500 text-white px-6 py-4 rounded-t-lg">
                <h3 class="text-lg font-semibold text-center uppercase">KUNJUNGAN RAWAT JALAN BARU</h3>
            </div>
            
            <div class="p-6">
                <form id="visitForm">
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-4 uppercase">KUNJUNGAN KE-4</h4>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1 uppercase">TANGGAL KUNJUNGAN</label>
                            <input type="date" value="2025-07-16" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1 uppercase">
                                POLIKLINIK <span class="text-red-500">*</span>
                            </label>
                            <select id="poliklinikSelect" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                                <option value="">Pilih poliklinik di sini</option>
                                <option value="Poli Bedah Ortopedi">Poli Bedah Ortopedi</option>
                                <option value="Poli Gigi">Poli Gigi</option>
                                <option value="Poli Umum">Poli Umum</option>
                            </select>
                            <div class="text-red-500 text-xs mt-1 hidden" id="poliklinikError">Harap pilih poliklinik!</div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1 uppercase">
                                DOKTER <span class="text-red-500">*</span>
                            </label>
                            <select id="dokterSelect" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                                <option value="">Pilih dokter di sini</option>
                                <option value="dr. Budi Sp.OT">dr. Budi Sp.OT</option>
                                <option value="drg. Andi Prasetyo, Sp.KG">drg. Andi Prasetyo, Sp.KG</option>
                                <option value="dr. Sarah">dr. Sarah</option>
                            </select>
                            <div class="text-red-500 text-xs mt-1 hidden" id="dokterError">Harap pilih dokter!</div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1 uppercase">
                                CARA BAYAR <span class="text-red-500">*</span>
                            </label>
                            <select id="caraBayarSelect" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                                <option value="">Pilih cara bayar</option>
                                <option value="BPJS">BPJS</option>
                                <option value="Umum">Umum</option>
                            </select>
                            <div class="text-red-500 text-xs mt-1 hidden" id="caraBayarError">Harap pilih cara bayar!</div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1 uppercase">KETERANGAN</label>
                            <textarea placeholder="Opsional" rows="3" 
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all resize-none"></textarea>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3 mt-6">
                        <button type="button" onclick="hideAddModal()" 
                                class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors">
                            Batal
                        </button>
                        <button type="button" onclick="saveVisit()" 
                                class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">
                            Simpan Kunjungan
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Sukses -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-lg p-8 w-full max-w-sm text-center transform transition-all duration-300 scale-95 opacity-0" id="successModalContent">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                </svg>
            </div>
            
            <h3 class="text-xl font-semibold text-gray-900 mb-2">Sukses</h3>
            <p class="text-gray-600 mb-6">Berhasil menambahkan kunjungan</p>
            
            <div class="flex space-x-3">
                <button onclick="hideSuccessModal()" 
                        class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors">
                    Tutup
                </button>
                <button onclick="showPrintModal()" 
                        class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">
                    Print Struk
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Print Struk -->
    <div id="printModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4" onclick="hidePrintModal()">
        <div class="bg-white rounded-lg w-full max-w-sm transform transition-all duration-300 scale-95 opacity-0" id="printModalContent" onclick="event.stopPropagation()">
            <div class="p-6">
                <div class="text-center border-b border-dashed border-gray-300 pb-4 mb-4">
                    <h3 class="text-lg font-bold text-gray-800">RSUD SLAWI</h3>
                    <h4 class="text-sm font-semibold text-gray-600">STRUK RAWAT JALAN</h4>
                </div>
                
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span>No. Registrasi</span>
                        <span id="printRegNo">: DG-20250717-01</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Tanggal Kunjungan</span>
                        <span id="printDate">: 17 Juli 2025</span>
                    </div>
                    <div class="flex justify-between">
                        <span>NRM</span>
                        <span id="printNrm">: 987654</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Nama Pasien</span>
                        <span id="printName">: Nabila Banati</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Poli Tujuan</span>
                        <span id="printPoli">: -</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Dokter Tujuan</span>
                        <span id="printDokter">: -</span>
                    </div>
                </div>
                
                <div class="border-t border-dashed border-gray-300 pt-4 mt-4 text-center text-xs text-gray-600">
                    Harap membawa struk ini ke poli tujuan<br>
                    Terima kasih atas kunjungan Anda
                </div>
                
                <div class="text-center mt-4 text-xs text-gray-500">
                    Klik di mana saja untuk menutup
                </div>
            </div>
        </div>
    </div>

    <script>
        // Sistem Manajemen Antrian
        class QueueSystem {
            constructor() {
                this.currentQueue = parseInt(localStorage.getItem('currentQueue')) || 1;
                this.totalQueue = parseInt(localStorage.getItem('totalQueue')) || 50;
                this.lokets = {
                    1: { status: 'active', currentNumber: this.currentQueue, remaining: this.totalQueue - this.currentQueue + 1 },
                    2: { status: 'active', currentNumber: 0, remaining: 0 },
                    3: { status: 'active', currentNumber: 0, remaining: 0 },
                    4: { status: 'active', currentNumber: 0, remaining: 0 },
                    5: { status: 'active', currentNumber: 0, remaining: 0 }
                };
                this.currentLoket = 1;
                this.isPaused = false;
                this.init();
            }

            init() {
                this.updateDisplay();
                this.loadLoketData();
                this.loadVoices();
            }
            
            loadVoices() {
                if ('speechSynthesis' in window) {
                    speechSynthesis.onvoiceschanged = () => {
                        this.voices = speechSynthesis.getVoices();
                    };
                    this.voices = speechSynthesis.getVoices();
                }
            }

            updateDisplay() {
                const currentQueueNumber = document.getElementById('currentQueueNumber');
                const currentLoket = document.getElementById('currentLoket');
                const remainingQueue = document.getElementById('remainingQueue');
                
                if (currentQueueNumber) currentQueueNumber.textContent = String(this.currentQueue).padStart(3, '0');
                if (currentLoket) currentLoket.textContent = this.currentLoket;
                if (remainingQueue) remainingQueue.textContent = this.lokets[this.currentLoket].remaining;
                
                const currentQueueDisplay = document.getElementById('currentQueueDisplay');
                const currentLoketDisplay = document.getElementById('currentLoketDisplay');
                const remainingQueueDisplay = document.getElementById('remainingQueueDisplay');
                
                if (currentQueueDisplay) currentQueueDisplay.textContent = String(this.currentQueue).padStart(3, '0');
                if (currentLoketDisplay) currentLoketDisplay.textContent = this.currentLoket;
                if (remainingQueueDisplay) remainingQueueDisplay.textContent = this.lokets[this.currentLoket].remaining;
                
                this.updateButtonStates();
            }

            updateButtonStates() {
                const resetBtn = document.getElementById('resetBtn');
                const soundBtn = document.getElementById('soundBtn');
                const nextBtn = document.getElementById('nextBtn');
                
                if (nextBtn) {
                    if (this.lokets[this.currentLoket].remaining <= 0) {
                        nextBtn.disabled = true;
                        nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
                        nextBtn.title = 'Tidak ada antrian lagi';
                    } else {
                        nextBtn.disabled = false;
                        nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        nextBtn.title = 'Antrian Selanjutnya';
                    }
                }
                
                if (soundBtn) {
                    if (this.currentQueue < 1) {
                        soundBtn.disabled = true;
                        soundBtn.classList.add('opacity-50', 'cursor-not-allowed');
                        soundBtn.title = 'Tidak ada antrian untuk dipanggil';
                    } else {
                        soundBtn.disabled = false;
                        soundBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        soundBtn.title = 'Panggil Antrian';
                    }
                }
            }

            loadLoketData() {
                const savedLokets = localStorage.getItem('loketData');
                if (savedLokets) {
                    this.lokets = JSON.parse(savedLokets);
                }
                const savedTotal = localStorage.getItem('totalQueue');
                if (savedTotal) {
                    this.totalQueue = parseInt(savedTotal);
                }
            }

            saveLoketData() {
                const loketDataNew = JSON.stringify(this.lokets);
                const loketDataOld = JSON.stringify({
                    loket1: this.lokets[1]?.currentNumber || 0,
                    loket2: this.lokets[2]?.currentNumber || 0,
                    loket3: this.lokets[3]?.currentNumber || 0,
                    loket4: this.lokets[4]?.currentNumber || 0,
                    loket5: this.lokets[5]?.currentNumber || 0,
                });
                
                localStorage.setItem('loketData', loketDataNew);
                localStorage.setItem('loketDataOld', loketDataOld);
                localStorage.setItem('currentQueue', this.currentQueue.toString());
                localStorage.setItem('currentNumber', this.currentQueue.toString());
                localStorage.setItem('totalQueue', this.totalQueue.toString());
            }

            callNextQueue() {
                if (this.isPaused) {
                    alert('Antrian sedang dijeda. Aktifkan kembali untuk melanjutkan.');
                    return;
                }

                if (this.lokets[this.currentLoket].remaining <= 0) {
                    alert('Tidak ada antrian lagi untuk hari ini.');
                    return;
                }

                this.currentQueue++;
                
                if (this.currentQueue > this.totalQueue) {
                    this.currentQueue = this.totalQueue;
                    alert('Antrian sudah mencapai batas maksimal hari ini.');
                    return;
                }

                this.lokets[this.currentLoket].currentNumber = this.currentQueue;
                this.lokets[this.currentLoket].remaining = Math.max(0, this.totalQueue - this.currentQueue + 1);
                
                this.updateDisplay();
                this.saveLoketData();
                this.announceQueue();
                this.broadcastUpdate();
            }

            announceQueue() {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    
                    const speech = new SpeechSynthesisUtterance(
                        `Nomor antrian ${this.currentQueue}, silakan menuju loket ${this.currentLoket}`
                    );
                    
                    speech.lang = 'id-ID';
                    speech.rate = 0.8;
                    speech.pitch = 1;
                    speech.volume = 1;
                    
                    const voices = this.voices || window.speechSynthesis.getVoices();
                    const indonesianVoice = voices.find(voice => 
                        voice.lang.includes('id') || 
                        voice.name.toLowerCase().includes('indo') ||
                        voice.lang.includes('ID')
                    );
                    
                    if (indonesianVoice) {
                        speech.voice = indonesianVoice;
                    }
                    
                    speech.onerror = function(event) {
                        console.error('Speech synthesis error:', event.error);
                    };
                    
                    setTimeout(() => {
                        window.speechSynthesis.speak(speech);
                    }, 100);
                } else {
                    this.showVisualNotification();
                }
            }
            
            showVisualNotification() {
                const notification = document.createElement('div');
                notification.innerHTML = `
                    <div class="fixed top-4 right-4 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300">
                        🔊 Antrian ${String(this.currentQueue).padStart(3, '0')} - Loket ${this.currentLoket}
                    </div>
                `;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
            }

            repeatCall() {
                if (this.currentQueue < 1) {
                    alert('Belum ada antrian yang dipanggil.');
                    return;
                }
                this.announceQueue();
            }

            resetQueue() {
                const confirmed = confirm('Yakin ingin reset antrian? Semua data antrian akan dikembalikan ke awal.');
                if (!confirmed) return;
                
                this.currentQueue = 1;
                this.totalQueue = 50;
                this.lokets[this.currentLoket].currentNumber = this.currentQueue;
                this.lokets[this.currentLoket].remaining = this.totalQueue - this.currentQueue + 1;
                this.updateDisplay();
                this.saveLoketData();
                this.broadcastUpdate();
                
                alert('Antrian telah direset ke nomor 001.');
            }

            broadcastUpdate() {
                const updateData = {
                    currentNumber: this.currentQueue,
                    loket: this.currentLoket,
                    remaining: this.lokets[this.currentLoket].remaining,
                    timestamp: Date.now(),
                    loketData: this.lokets
                };
                
                localStorage.setItem('queueUpdate', JSON.stringify(updateData));
                localStorage.setItem('currentNumber', this.currentQueue.toString());
                localStorage.setItem('loketData', JSON.stringify(this.lokets));
                
                window.dispatchEvent(new StorageEvent('storage', {
                    key: 'queueUpdate',
                    newValue: JSON.stringify(updateData)
                }));
            }
        }

        // Inisialisasi sistem antrian
        const queueSystem = new QueueSystem();

        // Data contoh pasien
        const patientData = [
            { id: 1, date: '16/07/2025', nrm: '000001', name: 'Muhammad Fadhlan', nik: 'THT251607001', gender: 'L', clinic: 'Poli Bedah Ortopedi', doctor: 'dr. Budi Sp.OT', payment: 'Umum', action: 'Pulang' },
            { id: 2, date: '16/07/2025', nrm: '000002', name: 'Siti Nurhaliza', nik: 'GG251607002', gender: 'P', clinic: 'Poli Gigi', doctor: 'drg. Andi Prasetyo, Sp.KG', payment: 'BPJS', action: 'Pindah Poli' },
            { id: 3, date: '16/07/2025', nrm: '000003', name: 'Ahmad Yusuf', nik: 'BDP251607003', gender: 'L', clinic: 'Poli Umum', doctor: 'dr. Sarah', payment: 'Umum', action: 'Rawat Inap' },
            { id: 4, date: '16/07/2025', nrm: '000004', name: 'Rina Sari', nik: 'THT251607004', gender: 'P', clinic: 'Poli Bedah Ortopedi', doctor: 'dr. Budi Sp.OT', payment: 'BPJS', action: 'Pulang' },
            { id: 5, date: '16/07/2025', nrm: '000005', name: 'Budi Santoso', nik: 'THT251607005', gender: 'L', clinic: 'Poli Gigi', doctor: 'drg. Andi Prasetyo, Sp.KG', payment: 'Umum', action: 'Pulang' },
            { id: 6, date: '16/07/2025', nrm: '000006', name: 'Dewi Lestari', nik: 'THT251607006', gender: 'P', clinic: 'Poli Umum', doctor: 'dr. Sarah', payment: 'BPJS', action: 'Pindah Poli' },
            { id: 7, date: '16/07/2025', nrm: '000007', name: 'Agus Wijaya', nik: 'THT251607007', gender: 'L', clinic: 'Poli Bedah Ortopedi', doctor: 'dr. Budi Sp.OT', payment: 'Umum', action: 'Pulang' },
            { id: 8, date: '16/07/2025', nrm: '000008', name: 'Maya Indira', nik: 'THT251607008', gender: 'P', clinic: 'Poli Gigi', doctor: 'drg. Andi Prasetyo, Sp.KG', payment: 'BPJS', action: 'Rawat Inap' },
            { id: 9, date: '16/07/2025', nrm: '000009', name: 'Roni Susanto', nik: 'THT251607009', gender: 'L', clinic: 'Poli Umum', doctor: 'dr. Sarah', payment: 'Umum', action: 'Pulang' },
            { id: 10, date: '16/07/2025', nrm: '000010', name: 'Lisa Amelia', nik: 'THT251607010', gender: 'P', clinic: 'Poli Bedah Ortopedi', doctor: 'dr. Budi Sp.OT', payment: 'BPJS', action: 'Pindah Poli' }
        ];

        let currentFormData = {};
        let filteredData = [...patientData];

        // Fungsi filter dengan umpan balik visual
        function applyFilter() {
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const payment = document.getElementById('filterPayment').value;
            const clinic = document.getElementById('filterClinic').value;
            const doctor = document.getElementById('filterDoctor').value;
            const search = document.getElementById('searchInput').value.toLowerCase();

            filteredData = patientData.filter(patient => {
                let matches = true;
                
                if (dateFrom && dateTo) {
                    const patientDate = new Date(patient.date.split('/').reverse().join('-'));
                    const fromDate = new Date(dateFrom);
                    const toDate = new Date(dateTo);
                    if (patientDate < fromDate || patientDate > toDate) matches = false;
                }
                
                if (payment && patient.payment !== payment) matches = false;
                if (clinic && patient.clinic !== clinic) matches = false;
                if (doctor && patient.doctor !== doctor) matches = false;
                
                if (search && !(
                    patient.nrm.toLowerCase().includes(search) ||
                    patient.name.toLowerCase().includes(search) ||
                    patient.nik.toLowerCase().includes(search)
                )) matches = false;

                return matches;
            });

            populateTable();
        }

        function resetFilter() {
            document.getElementById('dateFrom').value = '2025-07-16';
            document.getElementById('dateTo').value = '2025-07-16';
            document.getElementById('filterPayment').value = '';
            document.getElementById('filterClinic').value = '';
            document.getElementById('filterDoctor').value = '';
            document.getElementById('searchInput').value = '';
            
            filteredData = [...patientData];
            populateTable();
        }

        // Fungsi dropdown
        function toggleDropdown(id) {
            const dropdown = document.getElementById(`dropdown-${id}`);
            document.querySelectorAll('.dropdown-content').forEach(d => {
                if (d.id !== `dropdown-${id}`) {
                    d.classList.remove('show');
                }
            });
            dropdown.classList.toggle('show');
        }

        // Tutup dropdown saat klik di luar
        window.addEventListener('click', function(event) {
            if (!event.target.matches('.dropdown-btn')) {
                document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
            }
        });

        // Fungsi kontrol antrian
        function callNextQueueFunction() {
            queueSystem.callNextQueue();
        }

        function repeatCallFunction() {
            queueSystem.repeatCall();
        }

        function resetQueueFunction() {
            queueSystem.resetQueue();
        }

        // Pintasan keyboard
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                resetQueueFunction();
            } else if (e.code === 'Space' && !e.target.matches('input, textarea, select')) {
                e.preventDefault();
                repeatCallFunction();
            } else if (e.key === 'ArrowRight' && !e.target.matches('input, textarea, select')) {
                e.preventDefault();
                callNextQueueFunction();
            }
        });

        // Event listeners saat halaman dimuat
        document.addEventListener('DOMContentLoaded', function() {
            const filterInputs = ['filterPayment', 'filterClinic', 'filterDoctor', 'searchInput'];
            filterInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', applyFilter);
                    element.addEventListener('change', applyFilter);
                }
            });

            // Dukungan tombol Enter untuk pencarian
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    applyFilter();
                }
            });

            // Animasi modal
            setupModalAnimations();
        });

        function setupModalAnimations() {
            const modals = ['addModal', 'successModal', 'printModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                const content = document.getElementById(modalId + 'Content');
                
                if (modal && content) {
                    modal.addEventListener('transitionend', function() {
                        if (modal.classList.contains('hidden')) {
                            content.classList.remove('scale-100', 'opacity-100');
                            content.classList.add('scale-95', 'opacity-0');
                        }
                    });
                }
            });
        }

        // Fungsi untuk mendapatkan kelas badge aksi
        function getActionBadgeClass(action) {
            switch(action) {
                case 'Pulang':
                    return 'bg-blue-100 text-blue-800';
                case 'Pindah Poli':
                    return 'bg-yellow-100 text-yellow-800';
                case 'Rawat Inap':
                    return 'bg-green-100 text-green-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        // Isi tabel data
        function populateTable() {
            const tbody = document.getElementById('patientTable');
            tbody.innerHTML = '';
            
            filteredData.forEach(patient => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-900 text-center">${patient.id}</td>
                    <td class="px-4 py-3 text-sm text-center">
                        <div class="relative inline-block">
                            <button onclick="toggleDropdown(${patient.id})" 
                                    class="dropdown-btn px-3 py-1 bg-blue-100 text-blue-600 rounded text-xs hover:bg-blue-200 inline-flex items-center transition-colors">
                                <svg class="w-4 h-4 text-blue-800" fill="none" viewBox="0 0 24 24">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 9-7 7-7-7"/>
                                </svg>
                            </button>
                            <div id="dropdown-${patient.id}" class="dropdown-content absolute left-0 top-full mt-1 bg-white min-w-48 shadow-lg border rounded-lg z-50 hidden">
                                <a class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition-colors" onclick="showAddModal(${patient.id})">
                                    Tambah Kunjungan
                                </a>
                                <a class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition-colors" onclick="viewDetail(${patient.id})">
                                    Lihat Detail
                                </a>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-900">${patient.date}</td>
                    <td class="px-4 py-3 text-sm text-gray-900 font-medium">${patient.nrm}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${patient.name}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${patient.nik}</td>
                    <td class="px-4 py-3 text-sm text-gray-900 text-center">${patient.gender}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${patient.clinic}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${patient.doctor}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${patient.payment}</td>
                    <td class="px-4 py-3 text-sm">
                        <span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full ${getActionBadgeClass(patient.action)}">
                            ${patient.action}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        populateTable();

        // Tampilkan modal tambah kunjungan
        function showAddModal(patientId = null) {
            if (patientId) {
                const patient = patientData.find(p => p.id === patientId);
                if (patient) {
                    console.log('Menambah kunjungan untuk pasien:', patient.name);
                }
            }
            const modal = document.getElementById('addModal');
            const content = document.getElementById('addModalContent');
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
            
            currentFormData = { patientId };
        }

        // Sembunyikan modal tambah kunjungan
        function hideAddModal() {
            const modal = document.getElementById('addModal');
            const content = document.getElementById('addModalContent');
            
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                resetVisitForm();
            }, 300);
        }
        
        // Reset form kunjungan
        function resetVisitForm() {
            document.getElementById('poliklinikSelect').value = '';
            document.getElementById('dokterSelect').value = '';
            document.getElementById('caraBayarSelect').value = '';
            document.querySelector('textarea').value = '';
            clearFormErrors();
        }

        // Simpan kunjungan
        function saveVisit() {
            const poliklinik = document.getElementById('poliklinikSelect').value;
            const dokter = document.getElementById('dokterSelect').value;
            const caraBayar = document.getElementById('caraBayarSelect').value;
            
            clearFormErrors();
            let hasError = false;
            
            if (!poliklinik) {
                showFieldError('poliklinikSelect', 'poliklinikError');
                hasError = true;
            }
            
            if (!dokter) {
                showFieldError('dokterSelect', 'dokterError');
                hasError = true;
            }
            
            if (!caraBayar) {
                showFieldError('caraBayarSelect', 'caraBayarError');
                hasError = true;
            }
            
            if (hasError) return;
            
            currentFormData = {
                ...currentFormData,
                clinic: poliklinik,
                doctor: dokter,
                payment: caraBayar
            };
            
            hideAddModal();
            showSuccessModal();
        }
        
        // Fungsi bantuan untuk validasi form
        function showFieldError(fieldId, errorId) {
            const field = document.getElementById(fieldId);
            const error = document.getElementById(errorId);
            
            field.classList.add('border-red-500', 'ring-red-200');
            error.classList.remove('hidden');
            
            field.addEventListener('change', function() {
                clearFieldError(fieldId, errorId);
            }, { once: true });
        }
        
        function clearFieldError(fieldId, errorId) {
            const field = document.getElementById(fieldId);
            const error = document.getElementById(errorId);
            
            field.classList.remove('border-red-500', 'ring-red-200');
            error.classList.add('hidden');
        }
        
        function clearFormErrors() {
            const fields = ['poliklinikSelect', 'dokterSelect', 'caraBayarSelect'];
            const errors = ['poliklinikError', 'dokterError', 'caraBayarError'];
            
            fields.forEach((fieldId, index) => {
                clearFieldError(fieldId, errors[index]);
            });
        }

        // Tampilkan modal sukses
        function showSuccessModal() {
            const modal = document.getElementById('successModal');
            const content = document.getElementById('successModalContent');
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        // Sembunyikan modal sukses
        function hideSuccessModal() {
            const modal = document.getElementById('successModal');
            const content = document.getElementById('successModalContent');
            
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // Tampilkan modal print
        function showPrintModal() {
            document.getElementById('printPoli').textContent = `: ${currentFormData.clinic || '-'}`;
            document.getElementById('printDokter').textContent = `: ${currentFormData.doctor || '-'}`;
            
            const modal = document.getElementById('printModal');
            const content = document.getElementById('printModalContent');
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
            
            hideSuccessModal();
        }

        // Sembunyikan modal print
        function hidePrintModal() {
            const modal = document.getElementById('printModal');
            const content = document.getElementById('printModalContent');
            
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // Lihat detail pasien
        function viewDetail(id) {
            const patient = patientData.find(p => p.id === id);
            if (patient) {
                alert(`Detail Pasien:\nNama: ${patient.name}\nNRM: ${patient.nrm}\nPoli: ${patient.clinic}\nDokter: ${patient.doctor}`);
            }
        }
    </script>
    
    <style>
        .font-inter { font-family: 'Inter', sans-serif; }
        .dropdown-content.show { display: block; }
        .dropdown-content { display: none; }
    </style>
</body>
</html>
